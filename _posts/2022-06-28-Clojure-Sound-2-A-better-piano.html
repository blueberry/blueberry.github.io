---
date: 2022-06-28 21:05
author: dragan
layout: post
title: Clojure Sound 2 - A better piano
categories: 
- Clojure,
- Clojure
- Sound,
- Music
tags: 
excerpt: You might not be too thrilled with the sound richness of the default piano that played Maple Leaf Rag in the previous article. We can use a much better one, of course!
---
<p>
You might not be too thrilled with the sound richness of the default piano that played Maple Leaf Rag
in <a href="./Maple-Leaf-Rag-Clojure-Sound">the previous article</a>. We can use a much better one, of course! Here we broaden our understanding
of the basic building blocks that generate music in Clojure Sound]](<iframe class="github-btn" src="https://ghbtns.com/github-btn.html?user=uncomplicate&amp;repo=clojure-sound&amp;type=watch&amp;count=true" width="100" height="20" title="Star on GitHub" frameBorder="0"></iframe>): sequencers, synthesizers, and instruments.
</p>

<p>
If you followed along by trying out the code in your favorite Clojure REPL tool, you can continue
hacking on the same project.
</p>

<div id="outline-container-orgcba70b6" class="outline-2">
<h2 id="orgcba70b6">The namespaces</h2>
<div class="outline-text-2" id="text-orgcba70b6">
<p>
We use the same namespaces as before: <code>clojure-sound</code> 's <code>core</code> and <code>midi</code>, and a couple
general functions from uncomplicate commons library.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8b0000;">(</span>require '<span style="color: #006400;">[</span>uncomplicate.commons.core <span style="color: #96CBFE;">:refer</span> <span style="color: #ff1493;">[</span>close! info<span style="color: #ff1493;">]</span><span style="color: #006400;">]</span>
         '<span style="color: #006400;">[</span>uncomplicate.clojure-sound
           <span style="color: #ff1493;">[</span>core <span style="color: #96CBFE;">:refer</span> <span style="color: #96CBFE;">:all</span><span style="color: #ff1493;">]</span>
           <span style="color: #ff1493;">[</span>midi <span style="color: #96CBFE;">:refer</span> <span style="color: #96CBFE;">:all</span><span style="color: #ff1493;">]</span><span style="color: #006400;">]</span><span style="color: #8b0000;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org43cfb21" class="outline-2">
<h2 id="org43cfb21">The sequence and the sequencer</h2>
<div class="outline-text-2" id="text-org43cfb21">
<p>
As we did before, we use the music score of Scott Joplin's Maple Leaf Rag, encoded as a series
of music events (mostly notes to play) encoded in a midi file. As there are more than 100.000
events even in this short song, this is much more practical than invoking functions that
produce these same effects by hand.
</p>

<p>
The score is only a writing on the paper. Someone need to read these instructions, and
invoke them at precisely exact moments, as the song progresses. This is done by a
sequencer, which is basically our player, same as before. By invoking the <code>sequencer</code>
function, we get the default sequencer.
</p>


<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8b0000;">(</span><span style="color: #4c83ff;">def</span> <span style="color: #ff69b4;">maple</span> <span style="color: #006400;">(</span>sequence <span style="color: #ff1493;">(</span><span style="color: #afd8af;">clojure.java.io</span>/resource <span style="color: #61CE3C;">"maple.mid"</span><span style="color: #ff1493;">)</span><span style="color: #006400;">)</span><span style="color: #8b0000;">)</span>
<span style="color: #8b0000;">(</span><span style="color: #4c83ff;">def</span> <span style="color: #ff69b4;">sqcr</span> <span style="color: #006400;">(</span>sequencer<span style="color: #006400;">)</span><span style="color: #8b0000;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">#'user/maple</td>
</tr>

<tr>
<td class="org-left">#'user/sqcr</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org138ace3" class="outline-2">
<h2 id="org138ace3">Synthesizer</h2>
<div class="outline-text-2" id="text-org138ace3">
<p>
Now we come to something new: the instrument that the player plays. In the last article,
the sequencer used the defaults, so we didn't even know what was producing the sounds that we heard.
The sounds are generated by a synthesizer, which has the ability to produce actual sounds,
by any imaginable and unimaginable technique. The <code>synthesizer</code> function instantiate the
default implementation of a soft synthesizer, which we'll use here. Of course, we could
have accessed other software implementations, or even hardware synthesizers, if we had
one, and if it was connected to our computer, registered, and made accessible through
the drivers in our operating system. The default one is guaranteed to be present
on your computer if you have Java installed, which you surely do since you're happily
using Clojure.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8b0000;">(</span><span style="color: #4c83ff;">def</span> <span style="color: #ff69b4;">synth</span> <span style="color: #006400;">(</span>synthesizer<span style="color: #006400;">)</span><span style="color: #8b0000;">)</span>
</pre>
</div>

<pre class="example">
#'user/synth
</pre>
</div>
</div>

<div id="outline-container-org0900ae1" class="outline-2">
<h2 id="org0900ae1">Instrument collections</h2>
<div class="outline-text-2" id="text-org0900ae1">
<p>
The default synthesizer comes with default instruments. In my opinion, even the
default piano that comes with OpenJDK is not bad at all, but music connoisseurs
will know better sounds. We'll better acquire better instruments for our orchestra!
Instruments for our software synthesizer come as sound fonts, similarly to text fonts.
There are countless collections of quality sound fonts, free and commercial, so you'll
likely find something that matches your taste. Here I use <a href="https://keymusician01.s3.amazonaws.com/FluidR3_GM.zip">FluidR3</a>, a great free sound font
that comes with MuseScore. <a href="https://keymusician01.s3.amazonaws.com/FluidR3_GM.zip">Download it</a>, and put it somewhere on the classpath of your project.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8b0000;">(</span><span style="color: #4c83ff;">def</span> <span style="color: #ff69b4;">fluid</span> <span style="color: #006400;">(</span>soundbank <span style="color: #ff1493;">(</span><span style="color: #afd8af;">clojure.java.io</span>/resource <span style="color: #61CE3C;">"FluidR3_GM.sf2"</span><span style="color: #ff1493;">)</span><span style="color: #006400;">)</span><span style="color: #8b0000;">)</span>
</pre>
</div>

<pre class="example">
#'user/fluid
</pre>


<p>
Of course, other implementations of the Synthesizer interface may use other technologies
for software synthesis, and may or may not use sound fonts. Hardware synthesizers will
typically have yet other methods of working. What is important to us is that we can use
them all from Clojure Sound by invoking the same functions.
</p>

<p>
Once we reserve the synth by invoking <code>open!</code>, we load the fluid soundbank, and replace
the old orchestra with new, hopefully better one.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8b0000;">(</span>open! synth<span style="color: #8b0000;">)</span>
<span style="color: #8b0000;">(</span>load! synth fluid<span style="color: #8b0000;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">{:class "SoftSynthesizer", :status :open, :micro-position 0, :description "Software MIDI Synthesizer", :name "Gervill", :vendor "OpenJDK", :version "1.0"}</td>
</tr>

<tr>
<td class="org-left">true</td>
</tr>
</tbody>
</table>

<p>
We can invoke the <code>info</code> function to see whether this had any effect of our synth.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8b0000;">(</span>info fluid<span style="color: #8b0000;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-left">:class</td>
<td class="org-left">SF2Soundbank</td>
<td class="org-left">:description</td>
<td class="org-left">Licensed under the MIT License.</td>
<td class="org-left">:name</td>
<td class="org-left">Fluid R3 GM</td>
<td class="org-left">:vendor</td>
<td class="org-left">Frank Wen</td>
<td class="org-left">:version</td>
<td class="org-right">2.1</td>
</tr>
</tbody>
</table>

<p>
We can get all instruments in a nice Clojure sequence. As Maple Leaf Rag is performed on one instrument,
this is not too useful right now, but might be if more complex settings. We won't waste this sequence, though;
let's check how many instruments this synthesizer can simulate now.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8b0000;">(</span>count <span style="color: #006400;">(</span>instruments synth<span style="color: #006400;">)</span><span style="color: #8b0000;">)</span>
</pre>
</div>

<pre class="example">
189
</pre>
</div>
</div>

<div id="outline-container-orged94a59" class="outline-2">
<h2 id="orged94a59">Connecting sequencer and synthesizer</h2>
<div class="outline-text-2" id="text-orged94a59">
<p>
Now that we have a shiny new synthesizer, we have to connect it to the sequencer.
The polymorphic <code>connect!</code> function connect various things, among others, sequencers and synthesizers.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8b0000;">(</span>connect! sqcr synth<span style="color: #8b0000;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-left">:class</td>
<td class="org-left">SequencerTransmitter</td>
<td class="org-left">:id</td>
<td class="org-right">769064251</td>
</tr>
</tbody>
</table>

<p>
We should not forget to instruct the sequencer what to play.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8b0000;">(</span>open! sqcr<span style="color: #8b0000;">)</span>
<span style="color: #8b0000;">(</span>sequence! sqcr maple<span style="color: #8b0000;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">{:class "RealTimeSequencer", :status :open, :micro-position 0, :description "Software sequencer", :name "Real Time Sequencer", :vendor "Oracle Corporation", :version "Version 1.0"}</td>
</tr>

<tr>
<td class="org-left">{:class "RealTimeSequencer", :status :open, :micro-position 0, :description "Software sequencer", :name "Real Time Sequencer", :vendor "Oracle Corporation", :version "Version 1.0"}</td>
</tr>
</tbody>
</table>

<p>
After all this, we're ready to play!
</p>
</div>
</div>

<div id="outline-container-org10e3e23" class="outline-2">
<h2 id="org10e3e23">Play it again, Sam</h2>
<div class="outline-text-2" id="text-org10e3e23">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8b0000;">(</span>start! sqcr<span style="color: #8b0000;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">:class</td>
<td class="org-left">RealTimeSequencer</td>
<td class="org-left">:status</td>
<td class="org-left">:open</td>
<td class="org-left">:micro-position</td>
<td class="org-right">0</td>
<td class="org-left">:description</td>
<td class="org-left">Software sequencer</td>
<td class="org-left">:name</td>
<td class="org-left">Real Time Sequencer</td>
<td class="org-left">:vendor</td>
<td class="org-left">Oracle Corporation</td>
<td class="org-left">:version</td>
<td class="org-left">Version 1.0</td>
</tr>
</tbody>
</table>

<p>
I hope you've noticed how richer the sound is now compared to the one played on the default piano.
</p>

<p>
If you wanted to enjoy this song again, you might have noticed that repeated <code>start!</code> call results in silence.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8b0000;">(</span>start! sqcr<span style="color: #8b0000;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">:class</td>
<td class="org-left">RealTimeSequencer</td>
<td class="org-left">:status</td>
<td class="org-left">:open</td>
<td class="org-left">:micro-position</td>
<td class="org-right">139322</td>
<td class="org-left">:description</td>
<td class="org-left">Software sequencer</td>
<td class="org-left">:name</td>
<td class="org-left">Real Time Sequencer</td>
<td class="org-left">:vendor</td>
<td class="org-left">Oracle Corporation</td>
<td class="org-left">:version</td>
<td class="org-left">Version 1.0</td>
</tr>
</tbody>
</table>

<p>
Once the sequencer performs the score, it stops at the end. We can see where it is by calling <code>tick-position</code>
to get the current position in ticks, or <code>micro-position</code> to determine the time in microseconds after the beginning of the score.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8b0000;">(</span>micro-position sqcr<span style="color: #8b0000;">)</span>
</pre>
</div>

<pre class="example">
278645
</pre>


<p>
We can rewind the score, or point it anywhere, by invoking <code>micro-position!</code>, or <code>tick-position!</code>
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8b0000;">(</span>micro-position! sqcr 0<span style="color: #8b0000;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">:class</td>
<td class="org-left">RealTimeSequencer</td>
<td class="org-left">:status</td>
<td class="org-left">:open</td>
<td class="org-left">:micro-position</td>
<td class="org-right">0</td>
<td class="org-left">:description</td>
<td class="org-left">Software sequencer</td>
<td class="org-left">:name</td>
<td class="org-left">Real Time Sequencer</td>
<td class="org-left">:vendor</td>
<td class="org-left">Oracle Corporation</td>
<td class="org-left">:version</td>
<td class="org-left">Version 1.0</td>
</tr>
</tbody>
</table>

<p>
Now it's ready to play again.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8b0000;">(</span>start! sqcr<span style="color: #8b0000;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">:class</td>
<td class="org-left">RealTimeSequencer</td>
<td class="org-left">:status</td>
<td class="org-left">:open</td>
<td class="org-left">:micro-position</td>
<td class="org-right">140625</td>
<td class="org-left">:description</td>
<td class="org-left">Software sequencer</td>
<td class="org-left">:name</td>
<td class="org-left">Real Time Sequencer</td>
<td class="org-left">:vendor</td>
<td class="org-left">Oracle Corporation</td>
<td class="org-left">:version</td>
<td class="org-left">Version 1.0</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8b0000;">(</span>stop! sqcr<span style="color: #8b0000;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">:class</td>
<td class="org-left">RealTimeSequencer</td>
<td class="org-left">:status</td>
<td class="org-left">:open</td>
<td class="org-left">:micro-position</td>
<td class="org-right">286458</td>
<td class="org-left">:description</td>
<td class="org-left">Software sequencer</td>
<td class="org-left">:name</td>
<td class="org-left">Real Time Sequencer</td>
<td class="org-left">:vendor</td>
<td class="org-left">Oracle Corporation</td>
<td class="org-left">:version</td>
<td class="org-left">Version 1.0</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8b0000;">(</span>close! synth<span style="color: #8b0000;">)</span>
<span style="color: #8b0000;">(</span>close! sqcr<span style="color: #8b0000;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">{:class "SoftSynthesizer", :status :closed, :micro-position 0, :description "Software MIDI Synthesizer", :name "Gervill", :vendor "OpenJDK", :version "1.0"}</td>
</tr>

<tr>
<td class="org-left">{:class "RealTimeSequencer", :status :closed, :micro-position 0, :description "Software sequencer", :name "Real Time Sequencer", :vendor "Oracle Corporation", :version "Version 1.0"}</td>
</tr>
</tbody>
</table>

<p>
I like this song!
</p>
</div>
</div>
